---
import Base from '../../layouts/Base.astro';
import Hero from '../../components/Hero.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;
const withBase = (path) => `${base}${path.replace(/^\/+/, '')}`;
const allPages = await getCollection('threat-model');

// Organize pages by category
const devicePages = allPages.filter(p => p.id.startsWith('device-'));
const osPages = allPages.filter(p => p.id.startsWith('os-'));
const appPages = allPages.filter(p => p.id.startsWith('app-'));

const securityMechanisms = [
  {
    level: 'Device',
    items: [
      { title: 'Genuineness', href: withBase('/threat-model/device-genuineness/'), objectives: 'Genuineness' },
      { title: 'Secure Display and Inputs', href: withBase('/threat-model/device-secure-display-and-inputs/'), objectives: 'Confidentiality of user seeds, User consent' },
      { title: 'Physical Resistance', href: withBase('/threat-model/device-physical-resistance/'), objectives: 'Confidentiality of user seeds, Confidentiality of the firmware' },
    ]
  },
  {
    level: 'OS',
    items: [
      { title: 'PIN Security Mechanism', href: withBase('/threat-model/os-pin-security-mechanism/'), objectives: 'Confidentiality of user seeds' },
      { title: 'Random Number Generation', href: withBase('/threat-model/os-random-number-generation/'), objectives: 'Confidentiality of user seeds' },
      { title: 'Confidentiality of Seed and Private Keys', href: withBase('/threat-model/os-seed-confidentiality/'), objectives: 'Confidentiality of user seeds and private keys' },
      { title: 'Confidentiality and Integrity', href: withBase('/threat-model/os-confidentiality-and-integrity/'), objectives: 'Confidentiality of the firmware' },
      { title: 'Transport Security', href: withBase('/threat-model/os-transport-security/'), objectives: 'Confidentiality of the firmware' },
    ]
  },
  {
    level: 'App',
    items: [
      { title: 'Isolation', href: withBase('/threat-model/app-isolation/'), objectives: 'Confidentiality of private keys, User consent' },
      { title: 'User Consent', href: withBase('/threat-model/app-user-consent/'), objectives: 'User consent' },
    ]
  }
];
---

<Base 
  title="Threat Model" 
  description="Security objectives and mechanisms implemented in Ledger devices."
>
  <Hero 
    title="Threat Model" 
    subtitle="Security objectives and mechanisms implemented in Ledger devices to protect your digital assets."
    size="sm"
  />
  
  <section class="content">
    <div class="container">
      <div class="prose intro">
        <p>
          This page describes the threat model of Ledger devices (i.e. hardware products). It lists the main 
          security objectives the devices intend to fulfill, then describes the security mechanisms implemented 
          to achieve these objectives.
        </p>
      </div>
      
      <section class="section">
        <h2>Security Objectives</h2>
        <p class="section-intro">
          The main security objective of Ledger devices is to provide <strong>physical and logical</strong> 
          security to users' funds.
        </p>
        
        <div class="objectives-grid">
          <div class="objective-card">
            <div class="objective-card__number">1</div>
            <h3>Seed & Key Confidentiality</h3>
            <p>Guarantee the confidentiality of user seeds and private keys.</p>
          </div>
          
          <div class="objective-card">
            <div class="objective-card__number">2</div>
            <h3>User Consent</h3>
            <p>Ensure the use of digital assets is performed under user consent, preventing attackers from misleading users.</p>
          </div>
          
          <div class="objective-card">
            <div class="objective-card__number">3</div>
            <h3>Genuineness</h3>
            <p>Provide a mechanism allowing users to verify that their device is genuine.</p>
          </div>
          
          <div class="objective-card">
            <div class="objective-card__number">4</div>
            <h3>Privacy</h3>
            <p>Protect users' privacy and prevent unique identification of users.</p>
          </div>
          
          <div class="objective-card">
            <div class="objective-card__number">5</div>
            <h3>Firmware Protection</h3>
            <p>Protect the confidentiality of the firmware and the IP of the Secure Element.</p>
          </div>
        </div>
      </section>
      
      <section class="section">
        <h2>Definitions</h2>
        
        <h3>Roles</h3>
        <div class="roles-grid">
          <div class="role-card">
            <h4>End User</h4>
            <p>The owner of a Ledger device with physical access to it.</p>
          </div>
          <div class="role-card">
            <h4>Firmware Developer</h4>
            <p>Ledger employees who develop the OS and its cryptographic library.</p>
          </div>
          <div class="role-card">
            <h4>App Developer</h4>
            <p>Anyone who develops apps running on top of BOLOS.</p>
          </div>
          <div class="role-card">
            <h4>HSM</h4>
            <p>Hardware Security Modules that check device genuineness and perform privileged operations.</p>
          </div>
        </div>
        
        <h3>High Level Architecture</h3>
        <p>Ledger devices are composed of:</p>
        <ul>
          <li>A <strong>Secure Element</strong> (ST33 for Nano S Plus, Nano X, Stax and Flex)</li>
          <li>A general purpose <strong>MCU</strong> (STM32F042 for Nano S Plus, STM32WB55 for Nano X, STM32WB35 for Stax/Flex)</li>
          <li>A <strong>NFC communication chip</strong> (ST25R3916 for Stax and Flex)</li>
          <li>External peripherals: screen, buttons</li>
        </ul>
        
        <div class="architecture-images">
          <figure>
            <img src={withBase('/threat-model/architecture_nanox.png')} alt="Ledger Nano X Architecture" loading="lazy" />
            <figcaption>Nano S Plus / Nano X Architecture</figcaption>
          </figure>
          <figure>
            <img src={withBase('/threat-model/architecture_stax.png')} alt="Ledger Stax Architecture" loading="lazy" />
            <figcaption>Stax / Flex Architecture</figcaption>
          </figure>
        </div>
      </section>
      
      <section class="section" id="security-mechanisms">
        <h2>Security Mechanisms</h2>
        <p class="section-intro">
          Several security mechanisms are implemented at different levels. Click on each mechanism to learn more.
        </p>
        
        <div class="mechanisms-table">
          <table>
            <thead>
              <tr>
                <th>Level</th>
                <th>Security Mechanism</th>
                <th>Security Objectives</th>
              </tr>
            </thead>
            <tbody>
              {securityMechanisms.map((group) => (
                group.items.map((item, index) => (
                  <tr>
                    {index === 0 && (
                      <td rowspan={group.items.length} class="level-cell">
                        <span class={`level-badge level-badge--${group.level.toLowerCase()}`}>
                          {group.level}
                        </span>
                      </td>
                    )}
                    <td>
                      <a href={item.href}>{item.title}</a>
                    </td>
                    <td class="objectives-cell">{item.objectives}</td>
                  </tr>
                ))
              ))}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</Base>

<style lang="scss">
  .content {
    padding: var(--space-12) 0;
  }
  
  .intro {
    margin-bottom: var(--space-12);
    
    p {
      font-size: var(--text-lg);
      max-width: 800px;
    }
  }
  
  .section {
    margin-bottom: var(--space-16);
    
    h2 {
      font-size: var(--text-2xl);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }
    
    h3 {
      font-size: var(--text-lg);
      margin-top: var(--space-8);
      margin-bottom: var(--space-4);
      color: var(--color-text-secondary);
    }
  }
  
  .section-intro {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
    max-width: 700px;
  }
  
  .objectives-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--space-4);
    margin-top: var(--space-6);
  }
  
  .objective-card {
    padding: var(--space-5);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    
    &__number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      font-size: var(--text-sm);
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--color-accent-primary);
      background: var(--color-accent-glow);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }
    
    h3 {
      font-size: var(--text-base);
      margin: 0 0 var(--space-2);
      color: var(--color-text-primary);
    }
    
    p {
      font-size: var(--text-sm);
      color: var(--color-text-tertiary);
      margin: 0;
    }
  }
  
  .roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-top: var(--space-4);
  }
  
  .role-card {
    padding: var(--space-4);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    
    h4 {
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }
    
    p {
      font-size: var(--text-sm);
      color: var(--color-text-tertiary);
      margin: 0;
    }
  }
  
  .architecture-images {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
    margin-top: var(--space-6);
    
    figure {
      margin: 0;
      padding: var(--space-4);
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      
      img {
        width: 100%;
        height: auto;
        border-radius: var(--radius-md);
      }
      
      figcaption {
        margin-top: var(--space-3);
        font-size: var(--text-sm);
        color: var(--color-text-tertiary);
        text-align: center;
      }
    }
  }
  
  .mechanisms-table {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-top: var(--space-6);
    
    table {
      margin: 0;
    }
    
    th {
      text-align: left;
      font-size: var(--text-sm);
      background: var(--color-bg-tertiary);
    }
    
    td {
      vertical-align: middle;
    }
    
    a {
      font-weight: 500;
      
      &:hover {
        text-decoration: underline;
      }
    }
  }
  
  .level-cell {
    vertical-align: middle;
    text-align: center;
  }
  
  .level-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-sm);
    
    &--device {
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.15);
    }
    
    &--os {
      color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
    }
    
    &--app {
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.15);
    }
  }
  
  .objectives-cell {
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
  }
</style>

---
import Base from '../../layouts/Base.astro';
import Hero from '../../components/Hero.astro';
import Card from '../../components/Card.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;
const withBase = (path) => `${base}${path.replace(/^\/+/, '')}`;
const allLsb = await getCollection('lsb');
const datePattern = /^\s*(\d{1,2} [A-Za-z]+ \d{4})/m;
const bulletins = allLsb
  .map((bulletin) => {
    const id = bulletin.id.replace('.md', '');
    const date = bulletin.body.match(datePattern)?.[1] ?? '';
    return { bulletin, id, date };
  })
  .sort((a, b) => parseInt(b.id) - parseInt(a.id));
---

<Base 
  title="Security Bulletins" 
  description="Technical details of past security issues, their potential impact and available patches or workarounds."
>
  <Hero 
    title="Ledger Security Bulletins" 
    subtitle="Technical details of past security issues, their potential impact and available patches or workarounds."
    size="sm"
  />
  
  <section class="content">
    <div class="container">
      <p class="intro">
        Ledger believes in better security through openness. If you believe that you have discovered 
        a vulnerability, please report it through the <a href={withBase('/bounty/')}>bug bounty program</a>.
      </p>
      
      <div class="bulletins-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {bulletins.map(({ bulletin, id, date }) => {
              return (
                <tr>
                  <td>
                    <span class="bulletin-id">LSB {id}</span>
                  </td>
                  <td>
                    <a href={withBase(`/lsb/${id}/`)} class="bulletin-link">
                      {bulletin.data.title}
                      {bulletin.data.summary && (
                        <span class="bulletin-summary">{bulletin.data.summary}</span>
                      )}
                    </a>
                  </td>
                  <td>
                    {date && <time class="bulletin-date">{date}</time>}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      
      <p class="note">
        Note: these security bulletins are inspired by 
        <a href="https://www.qubes-os.org/security/bulletins/" target="_blank" rel="noopener">Qubes Security Bulletins</a> 
        but aren't related in any way.
      </p>
    </div>
  </section>
</Base>

<style lang="scss">
  .content {
    padding: var(--space-12) 0;
  }
  
  .intro {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    max-width: 700px;
    margin-bottom: var(--space-10);
  }
  
  .bulletins-table {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    
    table {
      margin: 0;
    }
    
    th {
      text-align: left;
      font-size: var(--text-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-tertiary);
      background: var(--color-bg-tertiary);
      
      &:first-child {
        width: 120px;
      }
      
      &:last-child {
        width: 160px;
      }
    }
    
    td {
      vertical-align: top;
    }
    
    tr:hover td {
      background: var(--color-bg-hover);
    }
  }
  
  .bulletin-id {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    font-weight: 600;
    font-family: var(--font-mono);
    color: var(--color-accent-primary);
    background: var(--color-accent-glow);
    border-radius: var(--radius-sm);
  }
  
  .bulletin-link {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    color: var(--color-text-primary);
    font-weight: 500;
    
    &:hover {
      color: var(--color-accent-primary);
      text-decoration: none;
    }
  }
  
  .bulletin-summary {
    font-size: var(--text-sm);
    font-weight: 400;
    color: var(--color-text-tertiary);
  }

  .bulletin-date {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    white-space: nowrap;
  }
  
  .note {
    margin-top: var(--space-10);
    font-size: var(--text-sm);
    color: var(--color-text-tertiary);
    font-style: italic;
  }
</style>
